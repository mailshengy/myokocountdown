<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Myoko Countdown + Dinner Voting</title>

  <style>
    :root{
      --paper:#efe6d8;
      --ink:#6b5e4b;
      --ink2:#7a6d5a;
      --sage:#9aa89b;
      --mist:#cfd8d3;
      --clay:#c9b2a0;
      --card: rgba(255,255,255,0.58);
      --card2: rgba(255,255,255,0.42);
      --shadow: 0 10px 28px rgba(0,0,0,0.06);
      --radius: 16px;
      --border: 1px solid rgba(107,94,75,0.12);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      color:var(--ink);
      background: radial-gradient(circle at top, #f4ede3, var(--paper));
    }

    a{ color: inherit; }
    .wrap{
      max-width: 1120px;
      margin: 0 auto;
      padding: 42px 18px 70px;
    }

    /* Top */
    header{
      text-align:center;
      padding: 18px 10px 8px;
    }
    .hero{
      background: linear-gradient(180deg, rgba(255,255,255,0.60), rgba(255,255,255,0.38));
      border-radius: 22px;
      padding: 22px 18px 28px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
      border: var(--border);
    }
    .title{
      font-size: 2.4rem;
      letter-spacing: 0.18em;
      font-weight: 520;
      margin: 10px 0 8px;
    }
    .subtitle{
      color: var(--ink2);
      letter-spacing: 0.12em;
      font-size: 0.95rem;
      margin: 0 0 22px;
    }

    /* Countdown */
    .countdown{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      max-width: 860px;
      margin: 0 auto;
    }
    .time-box{
      background: var(--card2);
      border-radius: var(--radius);
      padding: 18px 10px;
      border: var(--border);
    }
    .num{
      font-size: 2.55rem;
      font-weight: 540;
      color:#5f6f66;
      line-height: 1.1;
    }
    .lbl{
      margin-top: 6px;
      font-size: 0.75rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color:#7d8b82;
    }
    .statusline{
      margin-top: 14px;
      text-align:center;
      font-size: 0.92rem;
      color: #7d8b82;
      min-height: 1.2em;
    }

    /* Sections */
    .section{
      margin-top: 42px;
    }
    .section h2{
      text-align:center;
      font-size: 1.18rem;
      letter-spacing: 0.14em;
      font-weight: 650;
      margin: 0 0 12px;
      color: var(--ink);
      text-transform: uppercase;
    }
    .hint{
      text-align:center;
      margin: 0 auto 22px;
      max-width: 860px;
      color: var(--ink2);
      font-size: 0.95rem;
      line-height: 1.5;
    }

    /* Grid + cards */
    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px;
      align-items: stretch;
    }
    .card{
      background: var(--card);
      border-radius: 18px;
      padding: 18px 16px 16px;
      box-shadow: var(--shadow);
      border: var(--border);
      backdrop-filter: blur(6px);
    }

    .toprow{
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 12px;
    }
    .name{
      margin: 0;
      font-size: 1.12rem;
      font-weight: 700;
      letter-spacing: 0.02em;
    }
    .cuisine{
      margin-top: 6px;
      font-size: 0.9rem;
      color: var(--ink2);
    }

    .meta{
      display:flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-end;
      min-width: 220px;
    }
    .pillrow{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: flex-end;
    }
    .pill{
      display:inline-flex;
      gap: 8px;
      align-items:center;
      padding: 7px 10px;
      border-radius: 999px;
      border: var(--border);
      background: rgba(255,255,255,0.55);
      font-size: 0.82rem;
      color: var(--ink);
      white-space: nowrap;
    }
    .icon{
      width: 18px;
      height: 18px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius: 6px;
      background: rgba(154,168,155,0.22);
      border: 1px solid rgba(154,168,155,0.30);
      font-size: 0.95rem;
      line-height: 1;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 12px;
      margin-top: 12px;
      background: rgba(154,168,155,0.16);
      border: 1px solid rgba(154,168,155,0.30);
      color: #56645b;
      font-size: 0.88rem;
    }

    .desc{
      margin: 12px 0 0;
      color: #6f6150;
      line-height: 1.5;
      font-size: 0.95rem;
    }

    .links{
      margin-top: 12px;
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .linkbtn{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 9px 10px;
      border-radius: 12px;
      border: var(--border);
      background: rgba(255,255,255,0.55);
      text-decoration: none;
      font-size: 0.88rem;
      color: var(--ink);
      cursor: pointer;
    }
    .linkbtn:hover{ background: rgba(255,255,255,0.70); }

    .actions{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid rgba(107,94,75,0.10);
    }

    button.vote{
      border: none;
      background: #9aa89b;
      color: #fff;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 0.92rem;
      cursor: pointer;
      transition: transform 0.06s ease;
    }
    button.vote:active{ transform: scale(0.98); }
    button.vote:disabled{
      opacity: 0.55;
      cursor: not-allowed;
    }

    .votes{
      font-size: 0.9rem;
      color: var(--ink2);
      text-align:right;
      min-width: 88px;
    }

    .smallnote{
      margin-top: 10px;
      font-size: 0.82rem;
      color: #8a7d6a;
      text-align:center;
    }

    footer{
      margin-top: 40px;
      text-align:center;
      color: #8a7d6a;
      font-size: 0.82rem;
      line-height: 1.5;
    }

    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
      .meta{ align-items:flex-start; min-width: auto; }
      .pillrow{ justify-content:flex-start; }
    }
    @media (max-width: 520px){
      .countdown{ grid-template-columns: repeat(2, 1fr); }
      .num{ font-size: 2.05rem; }
      .title{ font-size: 2.05rem; }
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- COUNTDOWN -->
    <header>
      <div class="hero">
        <div class="title">MYOKO</div>
        <div class="subtitle">Countdown to 8 February 2026</div>

        <div class="countdown" aria-label="Countdown timer">
          <div class="time-box">
            <div class="num" id="days">0</div>
            <div class="lbl">Days</div>
          </div>
          <div class="time-box">
            <div class="num" id="hours">00</div>
            <div class="lbl">Hours</div>
          </div>
          <div class="time-box">
            <div class="num" id="minutes">00</div>
            <div class="lbl">Minutes</div>
          </div>
          <div class="time-box">
            <div class="num" id="seconds">00</div>
            <div class="lbl">Seconds</div>
          </div>
        </div>

        <div class="statusline" id="countdownStatus"></div>
      </div>
    </header>

    <!-- DINING OPTIONS -->
    <section class="section" id="dining">
      <h2>Dining Options for Dinner</h2>
      <p class="hint">
        Vote for your preferred dinner spot. Results are pulled from a shared Google Sheet.
        Each device can vote once per restaurant, saved in your browser.
      </p>

      <div class="grid" id="restaurantGrid"></div>

      <div class="smallnote">
        Voting works when your Apps Script Web App is deployed with access set to Anyone.
      </div>

      <div class="statusline" id="voteStatus"></div>
    </section>

    <footer>
      Tip: For a group of 12, confirm seating layout when booking.
      If a venue is very small, split the group into two tables or two time slots.
    </footer>
  </div>

  <script>
    /***********************
     * COUNTDOWN
     ***********************/
    const targetDate = new Date("2026-02-08T00:00:00").getTime();
    function pad2(n){ return String(n).padStart(2, "0"); }

    function updateCountdown() {
      const now = Date.now();
      const diff = targetDate - now;

      if (diff <= 0) {
        document.getElementById("days").textContent = "0";
        document.getElementById("hours").textContent = "00";
        document.getElementById("minutes").textContent = "00";
        document.getElementById("seconds").textContent = "00";
        document.getElementById("countdownStatus").textContent = "It is time.";
        return;
      }

      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
      const minutes = Math.floor((diff / (1000 * 60)) % 60);
      const seconds = Math.floor((diff / 1000) % 60);

      document.getElementById("days").textContent = days;
      document.getElementById("hours").textContent = pad2(hours);
      document.getElementById("minutes").textContent = pad2(minutes);
      document.getElementById("seconds").textContent = pad2(seconds);
      document.getElementById("countdownStatus").textContent = "";
    }

    updateCountdown();
    setInterval(updateCountdown, 1000);

    /***********************
     * LINKS HELPERS
     ***********************/
    function mapsSearchLink(query){
      return "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(query);
    }
    function mapsPhotosLink(query){
      // Opens Google Maps results, user can tap Photos
      return mapsSearchLink(query + " photos");
    }
    function mapsReviewsLink(query){
      // Opens Google Maps results, user can tap Reviews
      return mapsSearchLink(query + " reviews");
    }

    /***********************
     * DINING DATA
     * Includes map + photos + reviews links and extra planning notes
     ***********************/
    const restaurants = [
      {
        name: "Pontaro",
        cuisine: "Izakaya",
        groupFit: "Good",
        reservation: "Medium",
        why12: "Shared plates and a social layout makes one group booking more realistic.",
        details: [
          "Classic izakaya with lots of small dishes, good for ordering a wide spread for the table.",
          "Good pick if the group wants a lively dinner with drinks and relaxed pacing.",
          "Consider ordering a mix of grilled items, fried dishes, and seasonal specials to share."
        ],
        links: [
          { label: "Google Maps", icon: "üìç", url: mapsSearchLink("Pontaro izakaya Myoko Akakura") },
          { label: "Photos", icon: "üñºÔ∏è", url: mapsPhotosLink("Pontaro izakaya Myoko") },
          { label: "Reviews", icon: "‚≠ê", url: mapsReviewsLink("Pontaro izakaya Myoko") },
          { label: "Tripadvisor", icon: "üó£Ô∏è", url: "https://www.tripadvisor.com.sg/Restaurant_Review-g1021352-d9693451-Reviews-Izakaya_Pontaro-Myoko_Niigata_Prefecture_Koshinetsu_Chubu.html" },
          { label: "Myoko Tourism", icon: "‚ÑπÔ∏è", url: "https://myokotourism.com/restaurants/pontaro/" }
        ]
      },
      {
        name: "Yakitori Asagao",
        cuisine: "Yakitori",
        groupFit: "Limited",
        reservation: "Medium-Hard",
        why12: "Works best if you split into two tables or accept staggered seating.",
        details: [
          "Charcoal grilled skewers, usually served in rounds, great for sharing and trying many items.",
          "Seating is commonly counter based or small tables, so a full group of 12 may not fit together.",
          "Good choice if the group likes a focused food experience and does not mind splitting."
        ],
        links: [
          { label: "Google Maps", icon: "üìç", url: mapsSearchLink("Yakitori Asagao Myoko Akakura") },
          { label: "Photos", icon: "üñºÔ∏è", url: mapsPhotosLink("Yakitori Asagao Myoko") },
          { label: "Reviews", icon: "‚≠ê", url: mapsReviewsLink("Yakitori Asagao Myoko") },
          { label: "Tripadvisor", icon: "üó£Ô∏è", url: "https://www.tripadvisor.com/Restaurant_Review-g1021352-d12233128-Reviews-Yakitori_Asagao-Myoko_Niigata_Prefecture_Koshinetsu_Chubu.html" }
        ]
      },
      {
        name: "Udon no Fu",
        cuisine: "Udon",
        groupFit: "Poor for 12",
        reservation: "Hard",
        why12: "Best as a split group option, usually too small for 12 together.",
        details: [
          "Known for udon and comforting noodle meals, a good choice on cold nights.",
          "Venues like this tend to be compact, which makes one large booking difficult.",
          "Strong option for a smaller team lunch or an early dinner in two groups."
        ],
        links: [
          { label: "Google Maps", icon: "üìç", url: mapsSearchLink("Udon no Fu Myoko Akakura") },
          { label: "Photos", icon: "üñºÔ∏è", url: mapsPhotosLink("Udon no Fu Myoko") },
          { label: "Reviews", icon: "‚≠ê", url: mapsReviewsLink("Udon no Fu Myoko") },
          { label: "Tripadvisor", icon: "üó£Ô∏è", url: "https://www.tripadvisor.com.sg/Restaurant_Review-g1021352-d7557583-Reviews-Udon_No_Fu-Myoko_Niigata_Prefecture_Koshinetsu_Chubu.html" }
        ]
      },
      {
        name: "Noren Akakura Sushi",
        cuisine: "Sushi",
        groupFit: "Poor for 12",
        reservation: "Hard",
        why12: "A premium pick for a smaller sub group, not one table for 12.",
        details: [
          "High quality sushi in an intimate setting, often more quiet and chef focused.",
          "Capacity is usually limited, so plan on splitting into smaller groups.",
          "Good for a special night if you can secure a reservation."
        ],
        links: [
          { label: "Google Maps", icon: "üìç", url: mapsSearchLink("Noren Akakura Sushi Myoko") },
          { label: "Photos", icon: "üñºÔ∏è", url: mapsPhotosLink("Noren Akakura Sushi Myoko") },
          { label: "Reviews", icon: "‚≠ê", url: mapsReviewsLink("Noren Akakura Sushi Myoko") }
        ]
      },
      {
        name: "Takasago Sushi",
        cuisine: "Sushi",
        groupFit: "Poor for 12",
        reservation: "Hard",
        why12: "Works only if split, best for those who want traditional sushi.",
        details: [
          "Family run sushi with a more traditional feel and slower pacing.",
          "Small restaurant experience, which can be a plus if you want a quieter meal.",
          "Consider arranging two smaller bookings rather than one large group."
        ],
        links: [
          { label: "Google Maps", icon: "üìç", url: mapsSearchLink("Takasago Sushi Myoko Niigata") },
          { label: "Photos", icon: "üñºÔ∏è", url: mapsPhotosLink("Takasago Sushi Myoko") },
          { label: "Reviews", icon: "‚≠ê", url: mapsReviewsLink("Takasago Sushi Myoko") },
          { label: "Tripadvisor", icon: "üó£Ô∏è", url: "https://www.tripadvisor.com.sg/Restaurant_Review-g1021352-d7557657-Reviews-Takasago_Sushi-Myoko_Niigata_Prefecture_Koshinetsu_Chubu.html" }
        ]
      },
      {
        name: "Shokudo en",
        cuisine: "Yakiniku",
        groupFit: "Good",
        reservation: "Medium",
        why12: "BBQ format is made for groups, easy to order sets and share.",
        details: [
          "Tabletop grilling makes it interactive and keeps dinner social.",
          "Great for mixed preferences since people can choose their own cuts and sides.",
          "Confirm ventilation and table spacing for 12, then order shared sets plus extras."
        ],
        links: [
          { label: "Google Maps", icon: "üìç", url: mapsSearchLink("Shokudo en Myoko yakiniku") },
          { label: "Photos", icon: "üñºÔ∏è", url: mapsPhotosLink("Shokudo en Myoko") },
          { label: "Reviews", icon: "‚≠ê", url: mapsReviewsLink("Shokudo en Myoko") },
          { label: "Tripadvisor", icon: "üó£Ô∏è", url: "https://www.tripadvisor.com.sg/Restaurant_Review-g1021352-d7557656-Reviews-Shokudo_En-Myoko_Niigata_Prefecture_Koshinetsu_Chubu.html" },
          { label: "Myoko Tourism", icon: "‚ÑπÔ∏è", url: "https://myokotourism.com/restaurants/shokudoen/" }
        ]
      },
      {
        name: "Restaurant Shibata",
        cuisine: "Japanese",
        groupFit: "Excellent",
        reservation: "Easy-Medium",
        why12: "More flexible seating and a broad menu makes planning simple.",
        details: [
          "Large menu that usually suits a mixed group, including simpler comfort dishes.",
          "A good logistics friendly choice on peak nights when smaller venues are full.",
          "Confirm last order timing and table layout, then pre pick a few set meals to speed up ordering."
        ],
        links: [
          { label: "Google Maps", icon: "üìç", url: mapsSearchLink("Restaurant Shibata Myoko Akakura") },
          { label: "Photos", icon: "üñºÔ∏è", url: mapsPhotosLink("Restaurant Shibata Myoko") },
          { label: "Reviews", icon: "‚≠ê", url: mapsReviewsLink("Restaurant Shibata Myoko") },
          { label: "Myoko Tourism", icon: "‚ÑπÔ∏è", url: "https://myokotourism.com/restaurants/restaurant-shibata/" }
        ]
      },
      {
        name: "Restaurant Rudolf",
        cuisine: "Italian",
        groupFit: "Excellent",
        reservation: "Easy",
        why12: "Often handles large groups, shared pizzas and pasta are easy for 12.",
        details: [
          "Comfort option with pizza and pasta, great when the group wants something familiar.",
          "Good for sharing, you can order several pizzas plus a few pasta dishes for the table.",
          "Ideal backup when Japanese bookings are tight, still feels like a proper dinner."
        ],
        links: [
          { label: "Google Maps", icon: "üìç", url: mapsSearchLink("Restaurant Rudolf Myoko") },
          { label: "Photos", icon: "üñºÔ∏è", url: mapsPhotosLink("Restaurant Rudolf Myoko") },
          { label: "Reviews", icon: "‚≠ê", url: mapsReviewsLink("Restaurant Rudolf Myoko") },
          { label: "Tripadvisor", icon: "üó£Ô∏è", url: "https://www.tripadvisor.com/Restaurant_Review-g1021352-d4902024-Reviews-Restaurant_Rudolf-Myoko_Niigata_Prefecture_Koshinetsu_Chubu.html" }
        ]
      },
      {
        name: "Full Circle Snowsurf",
        cuisine: "Western / Cafe",
        groupFit: "Good",
        reservation: "Easy",
        why12: "Spacious seating and casual format makes it low stress for 12.",
        details: [
          "Relaxed spot that works well for a casual group dinner and drinks.",
          "Good for flexible timing, helpful when not everyone arrives at once.",
          "If you want a quieter sit down dinner, choose earlier, if you want lively, go later."
        ],
        links: [
          { label: "Google Maps", icon: "üìç", url: mapsSearchLink("Full Circle Snowsurf Cafe Restaurant Bar Myoko") },
          { label: "Photos", icon: "üñºÔ∏è", url: mapsPhotosLink("Full Circle Snowsurf Myoko") },
          { label: "Reviews", icon: "‚≠ê", url: mapsReviewsLink("Full Circle Snowsurf Myoko") },
          { label: "Tripadvisor", icon: "üó£Ô∏è", url: "https://www.tripadvisor.com/Restaurant_Review-g1021352-d13371720-Reviews-Full_Circle_Snowsurf_Cafe_Restaurant_Bar-Myoko_Niigata_Prefecture_Koshinetsu_Ch.html" },
          { label: "Instagram", icon: "üì∑", url: "https://www.instagram.com/flcircle/?hl=en" }
        ]
      },
      {
        name: "Obake Bar & Restaurant",
        cuisine: "Bar / Casual",
        groupFit: "Good",
        reservation: "Medium",
        why12: "Best for a social dinner, drinks, and a longer hangout after skiing.",
        details: [
          "Casual bar style dinner that suits a group that wants food plus drinks.",
          "Good vibe for celebrating, usually easier than tiny sushi counters, still book if possible.",
          "If part of the group has dietary needs, check menu options in advance."
        ],
        links: [
          { label: "Google Maps", icon: "üìç", url: mapsSearchLink("Obake Bar Myoko Akakura") },
          { label: "Photos", icon: "üñºÔ∏è", url: mapsPhotosLink("Obake Bar Myoko") },
          { label: "Reviews", icon: "‚≠ê", url: mapsReviewsLink("Obake Bar Myoko") },
          { label: "Instagram", icon: "üì∑", url: "https://www.instagram.com/obakebarmyoko/" },
          { label: "HappyCow", icon: "ü•ó", url: "https://www.happycow.net/reviews/obake-bar-myoko-445566" }
        ]
      }
    ];

    /***********************
     * ICONS
     ***********************/
    function groupTone(fit){
      const f = fit.toLowerCase();
      if (f.includes("excellent")) return "‚úÖ";
      if (f.includes("good")) return "üëç";
      if (f.includes("limited")) return "‚ö†Ô∏è";
      return "üö´";
    }
    function groupLabel(fit){
      const f = fit.toLowerCase();
      if (f.includes("excellent")) return "Group fit: Excellent";
      if (f.includes("good")) return "Group fit: Good";
      if (f.includes("limited")) return "Group fit: Limited";
      return "Group fit: Split needed";
    }
    function resIcon(level){
      const l = level.toLowerCase();
      if (l.includes("easy")) return "üü¢";
      if (l.includes("medium")) return "üü°";
      return "üî¥";
    }
    function resLabel(level){
      const l = level.toLowerCase();
      if (l.includes("easy")) return "Reservation: Easy";
      if (l.includes("medium")) return "Reservation: Medium";
      if (l.includes("hard")) return "Reservation: Hard";
      return "Reservation: Medium";
    }

    /***********************
     * GOOGLE SHEETS VOTING
     ***********************/
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxpMj-GRBmhoXdLnodt6bEJ9egh8RCvyqlnBfVC7Bk089s3m5VkepK1O-KlVMfZGimgTg/exec";
    const VOTE_KEY = "myoko_votes_v2";
    const voteStatus = document.getElementById("voteStatus");

    function setStatus(msg){ voteStatus.textContent = msg || ""; }

    function getVoteStore(){
      try { return JSON.parse(localStorage.getItem(VOTE_KEY) || "{}"); }
      catch { return {}; }
    }
    function setVoted(name){
      const store = getVoteStore();
      store[name] = true;
      localStorage.setItem(VOTE_KEY, JSON.stringify(store));
    }
    function hasVoted(name){
      return !!getVoteStore()[name];
    }

    /***********************
     * RENDER
     ***********************/
    const grid = document.getElementById("restaurantGrid");

    function safeId(name){
      return "r_" + name.replace(/[^a-zA-Z0-9]+/g, "_");
    }

    function renderRestaurants(){
      grid.innerHTML = "";

      restaurants.forEach(r => {
        const id = safeId(r.name);
        const voted = hasVoted(r.name);

        const detailsHtml = r.details.map(line => `<li>${line}</li>`).join("");
        const linksHtml = r.links.map(l =>
          `<a class="linkbtn" href="${l.url}" target="_blank" rel="noopener noreferrer">
             <span class="icon">${l.icon}</span><span>${l.label}</span>
           </a>`
        ).join("");

        const card = document.createElement("div");
        card.className = "card";
        card.setAttribute("data-name", r.name);

        card.innerHTML = `
          <div class="toprow">
            <div>
              <h3 class="name">${r.name}</h3>
              <div class="cuisine">${r.cuisine}</div>
            </div>
            <div class="meta">
              <div class="pillrow">
                <div class="pill" title="${groupLabel(r.groupFit)}">
                  <span class="icon">${groupTone(r.groupFit)}</span>
                  <span>${groupLabel(r.groupFit)}</span>
                </div>
                <div class="pill" title="${resLabel(r.reservation)}">
                  <span class="icon">${resIcon(r.reservation)}</span>
                  <span>${resLabel(r.reservation)}</span>
                </div>
              </div>
            </div>
          </div>

          <div class="badge" title="Why this works for 12">
            <span class="icon">üè∑Ô∏è</span>
            <span>${r.why12}</span>
          </div>

          <div class="desc">
            <ul style="margin:10px 0 0; padding-left: 18px;">
              ${detailsHtml}
            </ul>
          </div>

          <div class="links" aria-label="Links">
            ${linksHtml}
          </div>

          <div class="actions">
            <button class="vote" id="${id}_btn" ${voted ? "disabled" : ""}>
              ${voted ? "Voted" : "Vote"}
            </button>
            <div class="votes" id="${id}_votes">0 votes</div>
          </div>
        `;

        grid.appendChild(card);

        const btn = document.getElementById(`${id}_btn`);
        btn.addEventListener("click", () => vote(r.name));
      });
    }

    renderRestaurants();

    /***********************
     * VOTE POST
     * Uses form POST with no-cors, this avoids preflight issues.
     ***********************/
    async function vote(name){
      if (hasVoted(name)) {
        setStatus("You already voted for this option on this device.");
        return;
      }

      setStatus("Submitting vote...");

      try {
        const body = new URLSearchParams({ restaurant: name });

        await fetch(SCRIPT_URL, {
          method: "POST",
          mode: "no-cors",
          body
        });

        setVoted(name);
        renderRestaurants();
        setStatus("Vote submitted.");
        setTimeout(fetchVotesJSONP, 900);

      } catch (e) {
        setStatus("Vote failed. Recheck Apps Script deployment access.");
      }
    }

    /***********************
     * FETCH VOTES VIA JSONP
     * This bypasses CORS for reading counts.
     ***********************/
    function fetchVotesJSONP(){
      const cbName = "votes_cb_" + Math.random().toString(16).slice(2);

      window[cbName] = function(data){
        try {
          // Update counts
          restaurants.forEach(r => {
            const id = safeId(r.name);
            const count = (data && data[r.name]) ? data[r.name] : 0;
            const el = document.getElementById(`${id}_votes`);
            if (el) el.textContent = `${count} votes`;
          });

          // Sort cards by votes high to low
          const cards = Array.from(grid.querySelectorAll(".card"));
          cards.sort((a, b) => {
            const an = a.getAttribute("data-name");
            const bn = b.getAttribute("data-name");
            const av = (data && data[an]) ? data[an] : 0;
            const bv = (data && data[bn]) ? data[bn] : 0;
            return bv - av;
          });
          cards.forEach(c => grid.appendChild(c));
        } finally {
          cleanup();
        }

        function cleanup(){
          delete window[cbName];
          const s = document.getElementById(cbName);
          if (s) s.remove();
        }
      };

      const script = document.createElement("script");
      script.id = cbName;
      script.src = `${SCRIPT_URL}?callback=${cbName}&_=${Date.now()}`;
      document.body.appendChild(script);
    }

    fetchVotesJSONP();
    setInterval(fetchVotesJSONP, 8000);
  </script>
</body>
</html>
